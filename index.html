<!doctype html>
<html>
	<head>
		<title>Pitch Detector</title>
		<style>
			body { font: 14pt Arial, sans-serif;}
			#note { font-size: 164px; }
			.droptarget { background-color: #348781}
			div.confident { color: black; }
			div.vague { color: lightgrey; }
			#note { display: inline-block; height:180px; text-align: left;}

			#detector { width: 300px; height: 300px; border: 4px solid gray; border-radius: 8px; text-align: center; padding-top: 10px;}
			#output { width: 300px; height: 42px; }
			#flat { display: none; }
			#sharp { display: none; }
			.flat #flat { display: inline; }
			.sharp #sharp { display: inline; }
		</style>
	</head>
	<body>
		<script src="js/pitchdetect.js"></script>

		<p>
			<button onclick="this.innerText = togglePlayback()">use demo audio</button>
			<button onclick="toggleLiveInput()">use live input</button>
			<button onclick="toggleOscillator()">use oscillator</button>
			<!-- <button onclick="updatePitch(0);">sample</button> -->
		</p>

		<div id="detector" class="vague">
			<div class="pitch"><span id="pitch">--</span>Hz</div>
			<div class="note"><span id="note">--</span></div>
			<canvas id="output" width=300 height=42></canvas>
			<div id="detune"><span id="detune_amt">--</span><span id="flat">cents &#9837;</span><span id="sharp">cents &#9839;</span></div>
		</div>

        <script src="./string.js" charset="utf-8"></script>
        <script src="./note.js" charset="utf-8"></script>
		<script src="./notePlayer.js" charset="utf-8"></script>

        <canvas id="canvas" width="1600" height="500"></canvas>

        <script type="text/javascript">

            // Guitar strings
            var Ebig;
            var A;
            var D;
            var G;
            var B;
            var Esmall;

            // The player that creates all of the seperate notes.
            var notePlayer;

            var pause = false;
            var background;
            var pixelSpeed = 3;

            var chords = [];
            var chordsInPlay = [];

            var tempo = 60;

            // Global timer for new chords and notes to be put into played
            var globalTime = new Date();
			// initialized when game is pauzed by pressing spacebar
            var pauzeDate;

                document.addEventListener("keydown",keyPush);
                canv=document.getElementById("canvas");
                ctx=canv.getContext("2d");
                setup();


            function musicNote(name, timeInterval) {
              this.name = name;
              // The +500 ensures all of the text is in place before the chords show up. You can safely rewmove it to see the difference.
              this.position = {x:canvas.width + 500, y:canvas.height/2, drawSize: 0};
              this.timeInterval = timeInterval;
              this.date;
            }

            function setup() {
              background = new Image();
              background.src = "./background.png";
              Ebig    = new String("Ebig", canvas, ctx, 140, "grey");
              A       = new String("A", canvas, ctx, 200, "rgb(194, 192, 192)");
              D       = new String("D", canvas, ctx, 260, "rgb(201, 201, 201)");
              G       = new String("G", canvas, ctx, 320, "rgb(215, 215, 149)");
              B       = new String("B", canvas, ctx, 380, "rgba(215, 215, 149, 0.75)");
              Esmall  = new String("Esmall", canvas, ctx, 440, "rgba(215, 215, 149, 0.50)");

              // Create the notePlayer that plays all of the notes.
              notePlayer = new notePlayer();

              // The song.
              notePlayer.notes.push(new Note(0, 0, 0.5, canv, ctx, Esmall.y, "E"));
              notePlayer.notes.push(new Note(0, 0.5, 0.5, canv, ctx, Esmall.y, "E"));
              notePlayer.notes.push(new Note(1, 0.5, 0.5, canv, ctx, Esmall.y, "F"));
              notePlayer.notes.push(new Note(3, 0.5, 0.5, canv, ctx, Esmall.y, "G"));
              notePlayer.notes.push(new Note(3, 0.5, 0.5, canv, ctx, Esmall.y, "G"));
              notePlayer.notes.push(new Note(1, 0.5, 0.5, canv, ctx, Esmall.y, "F"));
              notePlayer.notes.push(new Note(0, 0.5, 0.5, canv, ctx, Esmall.y, "E"));
              notePlayer.notes.push(new Note(3, 0.5, 0.5, canv, ctx, B.y, "D"));
              notePlayer.notes.push(new Note(1, 0.5, 0.5, canv, ctx, B.y, "C"));
              notePlayer.notes.push(new Note(1, 0.5, 0.5, canv, ctx, B.y, "C"));
              notePlayer.notes.push(new Note(3, 0.5, 0.5, canv, ctx, B.y, "D"));
              notePlayer.notes.push(new Note(0, 0.5, 0.5, canv, ctx, Esmall.y, "E"));
              notePlayer.notes.push(new Note(0, 0.5, 0.8, canv, ctx, Esmall.y, "E"));
              notePlayer.notes.push(new Note(3, 0.25, 0.25, canv, ctx, B.y, "D"));
              notePlayer.notes.push(new Note(3, 0.25, 1, canv, ctx, B.y, "D"));
              notePlayer.notes.push(new Note(0, 0.5, 0.5, canv, ctx, Esmall.y, "A"));
              notePlayer.notes.push(new Note(0, 0.5, 0.5, canv, ctx, Esmall.y, "A"));
              notePlayer.notes.push(new Note(1, 0.5, 0.5, canv, ctx, Esmall.y, "A"));
              notePlayer.notes.push(new Note(3, 0.5, 0.5, canv, ctx, Esmall.y, "A"));
              notePlayer.notes.push(new Note(3, 0.5, 0.5, canv, ctx, Esmall.y, "A"));
              notePlayer.notes.push(new Note(1, 0.5, 0.5, canv, ctx, Esmall.y, "A"));
              notePlayer.notes.push(new Note(0, 0.5, 0.5, canv, ctx, Esmall.y, "A"));
              notePlayer.notes.push(new Note(3, 0.5, 0.5, canv, ctx, B.y, "A"));
              notePlayer.notes.push(new Note(1, 0.5, 0.5, canv, ctx, B.y, "A"));
              notePlayer.notes.push(new Note(1, 0.5, 0.5, canv, ctx, B.y, "A"));
              notePlayer.notes.push(new Note(3, 0.5, 0.5, canv, ctx, B.y, "A"));
              notePlayer.notes.push(new Note(0, 0.5, 0.5, canv, ctx, Esmall.y, "A"));
              notePlayer.notes.push(new Note(3, 0.5, 0.8, canv, ctx, B.y, "A"));
              notePlayer.notes.push(new Note(1, 0.25, 0.25, canv, ctx, B.y, "A"));
              notePlayer.notes.push(new Note(1, 0.25, 1, canv, ctx, B.y, "A"));

              clearCanvas();

              chords = [
                // new musicNote("Em", 4), new musicNote("G", 4), new musicNote("D", 4), new musicNote("A", 4),
                // new musicNote("Em", 4), new musicNote("G", 4), new musicNote("D", 4), new musicNote("A", 4),
              ];

              chordsInPlay = [];
            }

            function song() {

              if(!pause) {
                notePlayer.addNotesInPlay();
                // Clear the canvas for the next drawing cycle;
                clearCanvas();

                // Draw the guitar strings onto the screen.
                Ebig.drawString();
                A.drawString();
                D.drawString();
                G.drawString();
                B.drawString();
                Esmall.drawString();

                // Draw the line the player follows.
                drawPlayLine();

                notePlayer.moveNotes();

                // Add the next chord to be played to the chordsInPlay list.
                // drawChords();

                // Draw and move the chords that have been drawn.
                // moveChords();

                requestAnimationFrame(song);
              }
            }

            // Pushes chords into the chordsInPlay list at the right moment.
            // After this function the *moveChords()* function takes over.
            function drawChords() {
              chords.forEach((chord, index) => {
                if(new Date() >= globalTime) {
                  addSecondsToGlobalTimer(chord.timeInterval);
                  chord.date = new Date();
                  chord.endDate = new Date();
                  chord.endDate.setSeconds(chord.endDate.getSeconds() + calculateTempo(chord.timeInterval));
                  chord.number = 0;
                  chordsInPlay.push(chord);
                  chords.splice(index, 1);
                }
              });
            }

            function moveChords() {
              // chord.position.x + chord.position.drawSize is the right most position of a chord block.
              chordsInPlay.forEach((chord, index) => {
                colorByName(chord);
                if(chord.date < chord.endDate) {
                  chord.position.drawSize += pixelSpeed;
                  ctx.fillRect(chord.position.x, chord.position.y, chord.position.drawSize, canv.height);
                  chord.date = new Date();
                  chord.number -= pixelSpeed / 2;
                }
                else {
                  // chord.position.drawSize -= 2;
                  ctx.fillRect(chord.position.x, chord.position.y, chord.position.drawSize, canv.height);
                }

                // If a chord is passing the play line, draw the play line a different color.
                if(chord.position.x < 300 && chord.position.x + chord.position.drawSize > 305) {
                  drawPlayLine("rgb(179, 140, 120)");
                }

                writeChordName(chord);
                setChordPosition(chord);
                removeChord(chord, index);
              });
            }

            function writeChordName(chord) {
              ctx.fillStyle = "white";
              ctx.textAlign = "center";
              ctx.fillText(chord.name, chord.position.x + chord.position.drawSize + chord.number, (chord.position.y + canv.height) / 2, canv.width, canv.height);
            }

            function setChordPosition(chord) {
              chord.position.x -= pixelSpeed;
            }

            function removeChord(chord, index) {
              if(chord.position.x + chord.position.drawSize <= -1000) {
                chordsInPlay.splice(index, 1);
              }
            }

            function drawPlayLine(color) {
              if(color) {
                ctx.fillStyle = color;
              }
              else {
                ctx.fillStyle = "grey";
              }
              ctx.fillRect(300, 30, 5, canvas.height);
            }

            function clearCanvas() {
              ctx.clearRect(0,0,canv.width,canv.height);
              ctx.drawImage(background,0,0);
            }

            function addSecondsToGlobalTimer(seconds) {
              globalTime.setSeconds(globalTime.getSeconds() + calculateTempo(seconds));
            }

            function calculateTempo(seconds) {
              let bpm = tempo / 60;
              return seconds / bpm;
            }

			// The colours of chords.
            function colorByName(chord) {
              switch(chord.name) {
                case "C":
                  ctx.fillStyle = "blue";
                  break;
                case "D":
                  ctx.fillStyle = "red";
                  break;
                case "F":
                  ctx.fillStyle = "purple";
                  break;
                case "G":
                  ctx.fillStyle = "green";
                  break;
                case "Am":
                  ctx.fillStyle = "orange";
                  break;
                case "E":
                  ctx.fillStyle = "pink";
                  break;
                case "A":
                  ctx.fillStyle = "#5cd3b8";
                  break;
                case "Em":
                  ctx.fillStyle = "#d3d35c"
              }
            }

            // Used to pause the game.
            function keyPush(evt) {
              switch(evt.keyCode) {
                  case 32:
                      if(!pause) {
                        pause = true;
                        pauzeDate = new Date();
                      }
                      else {
                        var pauzedTime = new Date();

						// Calculate time the game was pauzed for.
                        pauzedTime.setTime(pauzedTime.valueOf() - pauzeDate.valueOf());

						// Set new globalTime. This has to be done this way since new notes are created based the time since the previous note was played.
                        globalTime.setTime(globalTime.valueOf() + pauzedTime.valueOf());
                        pause = false;

						// Restart the loop.
						requestAnimationFrame(song);
                      }
                      break;
              }
            }

            requestAnimationFrame(song);
        </script>

		<!-- just used for debugging
		<canvas id="waveform" width="512" height="256"></canvas> -->
	</body>
</html>
